backup ganeti cluster using lvm snapshots and rsync to zfs snapshots

This tools depend on scripts in https://github.com/ffzg/gnt-info repository
to create lvm snapshots and push them to rsync server (machine with zfs).


FIXME - add detailed installation description here


Add new ganeti cluster (r1u28) to backup server (lib15):

1. create ssh key to access r1u28

root@lib15:~/.ssh# ssh-keygen -t dsa -f ./r1u28-id_dsa

2. add it to authorized_keys on r1u28 and configure backup
   destination on lib15 and path to lvm+rsync script

command="backup=oscar /srv/gnt-info/gnt-lv-snap-rsync.sh -" ssh-dss ...

3. generate ssh key on r1u28 to create snapshot on lib15 and distribute it

root@r1u28:# ssh-keygen -t dsa -f /etc/ganeti/id_dsa-zfs-snap

root@r1u28:# gnt-cluster copyfile /etc/ganeti/id_dsa-zfs-snap

4. add it to authorized_keys on lib15

command="/srv/zfs-tools/ssh/zfs-snap.sh" ssh-dss ...

5. add it to cron backup script

export backup=oscar
/srv/zfs-tools/backup-instances-today.sh | xargs -i echo \
 'echo {} | ssh -i /root/.ssh/r1u28-id_dsa r1u28 | tee "/dev/shm/cron.{}.log"' \
 | tee /dev/shm/cron-$backup.sh
sh -xe /dev/shm/cron-$backup.sh



Create backup from ganeti intance SOP:

1. export instance using gnt-backup

gnt-backup export --noshutdown -n r1u28 delta

2. import backup into zfs filesystem
   (backup enviroment variable is top-level directory for backups)

backup=oscar /srv/zfs-tools/restore-to-zfs-fs.sh \
	/var/lib/ganeti/export/delta/a39fa7b8-8a5d-4bf2-a9a9-438761357446

3. now rename backup directory to contain disk number starting from 0
   instead of uuid used by ganeti

zfs rename lib15/oscar/delta/3978-85-42-99-438761357446 lib15/oscar/delta/0



Create backup from ganeti without existing gnt-backup export

1. create new directory for instance disk 0

zfs create -p lib15/oscar/a1.ffzg.unizg.hr/0

2. manually invoke first rsync

echo a1.ffzg.unizg.hr 0 | ssh -i /root/.ssh/r1u28-id_dsa r1u28



rsync exclude and other parametars

If you create lib15/oscar/instance/rsync.args file and put
"--exclude path/to/exclude" in one or more lines, this will be
applied when transfering files to zfs rsync server from
https://github.com/ffzg/gnt-info/blob/master/gnt-lv-snap-rsync.sh



Tweaks you can do to installed instances:

optimize logrotate to include date in filename (to prevent multiple copies
on copy-on-write filesystem like zfs)

perl -p -i -n -e 's/(\s+)daily/$1daily\n$1dateext/' /etc/logrotate.d/*



List backups showing written which is real size of uncompressed data:

zfs list -r -t all -o space,logicalreferenced,written,compressratio lib20/backup
